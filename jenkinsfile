pipeline {
    agent any

    environment {
        ZAP_PATH = "/opt/zaproxy/zap.sh"  // Chemin vers le script zap.sh installé
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'Checking out code from GitHub...'
                // Utilisation de l'étape Checkout pour récupérer le dépôt GitHub
                git 'https://github.com/gabriel25115CG/HeartSenseAI'
            }
        }

        stage('Run OWASP ZAP') {
            steps {
                echo 'Running OWASP ZAP...'

                // Lancer ZAP en mode démon
                sh '''
                    ${ZAP_PATH} -daemon -config api.disablekey=true
                    # Attendre quelques secondes pour que ZAP se lance correctement
                    sleep 10
                    # Exécuter un scan rapide sur ton application
                    curl -X POST "http://localhost:8080/JSON/ascan/action/scan" -d "url=http://localhost:8080" -d "maxDepth=5" -d "enableContextualAlerts=false"
                    # Attendre la fin du scan
                    sleep 30
                    # Générer un rapport HTML du scan
                    ${ZAP_PATH} -cmd -quickurl http://localhost:8080 -report zap-report.html
                '''
            }
        }

        stage('Archive Report') {
            steps {
                echo 'Archiving OWASP ZAP report...'
                // Archiver le rapport généré pour y avoir accès dans Jenkins
                archiveArtifacts artifacts: 'zap-report.html', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
            // Fermer ZAP après l'exécution du scan
            sh 'kill $(ps aux | grep "[z]ap" | awk "{print $2}") || true'
        }
    }
}
